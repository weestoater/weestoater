{"version":3,"file":"CascadingMenu.js","sources":["../src/cascading-menu/CascadingMenu.tsx"],"sourcesContent":["import {\n  useControlled,\n  useDensity,\n  useForkRef,\n  ownerWindow,\n  usePrevious,\n} from \"@salt-ds/core\";\nimport {\n  cloneElement,\n  forwardRef,\n  isValidElement,\n  ReactNode,\n  useCallback,\n  useEffect,\n  useMemo,\n  useReducer,\n  useRef,\n  useState,\n  MouseEvent,\n  KeyboardEvent,\n} from \"react\";\nimport { useEventCallback } from \"../utils\";\n\nimport { CascadingMenuProps, MenuDescriptor } from \"./CascadingMenuProps\";\n\nimport { CascadingMenuList } from \"./CascadingMenuList\";\nimport { CascadingMenuAction } from \"./internal/CascadingMenuAction\";\nimport { defaultGetScreenBounds } from \"./internal/menuPositioning\";\nimport { deriveFlatStateFromTree } from \"./internal/stateUtils\";\nimport { useClickAway } from \"./internal/useClickAway\";\nimport { useMenuTriggerHandlers } from \"./internal/useMenuTriggerHandlers\";\nimport { useRefsManager } from \"./internal/useRefsManager\";\nimport { useStateReducer } from \"./internal/useStateReducer\";\nimport { stateChangeTypes } from \"./stateChangeTypes\";\n\nconst defaultItemToString = (item: any) => item?.title || String(item);\n\nconst noop = () => undefined;\n\nexport const CascadingMenu = forwardRef<HTMLDivElement, CascadingMenuProps>(\n  function CascadingMenu(props, ref) {\n    const {\n      children,\n      className,\n      initialSource: initialSourceProp,\n      itemToString = defaultItemToString,\n      onClose,\n      onItemClick,\n      onOpen,\n      maxWidth = 544,\n      minWidth = 200,\n      delay = 300,\n      rowHeight,\n      tooltipEnterDelay = 1500,\n      tooltipLeaveDelay = 0,\n      height,\n      rootPlacement,\n      // Add this to offset x, y on popper open\n      rootPlacementOffset,\n      menuTriggerRef: anchorRefProp,\n      open: openProp,\n      getScreenBounds = defaultGetScreenBounds,\n      disableMouseOutInteractions,\n      disableClickAway,\n      containingDocument = globalThis.document,\n      source: sourceProp,\n    } = props;\n    const density = useDensity();\n\n    const refsManager = useRefsManager();\n    const childrenRef = useRef<HTMLElement | null>(null);\n    const getMenuTriggerRef = useCallback(\n      (): HTMLElement | null => anchorRefProp || childrenRef.current,\n      [anchorRefProp]\n    );\n\n    const [menuSource] = useControlled({\n      controlled: sourceProp,\n      default: initialSourceProp,\n      name: \"CascadingMenu\",\n      state: \"source\",\n    });\n\n    const [isNavigatingWithKeyboard, setIsNavigatingWithKeyboard] =\n      useState(false);\n\n    const menusDataById = useMemo(\n      () => (menuSource ? deriveFlatStateFromTree(menuSource) : {}),\n      [menuSource]\n    );\n\n    const rootMenuId = useMemo(\n      () =>\n        Object.keys(menusDataById).find((id) => menusDataById[id].level === 0),\n      [menusDataById]\n    );\n\n    const stateReducer = useStateReducer(\n      menusDataById,\n      isNavigatingWithKeyboard\n    );\n    const [state, dispatch] = useReducer(stateReducer, []);\n    const rootMenuState = state[0];\n\n    // Call open and close callbacks after rendering as we know for sure whether the cascading menu is open or closed\n    const prevState = usePrevious(state, undefined, []);\n    const prevRootMenuState = prevState?.[0];\n    useEffect(() => {\n      if (!!rootMenuState !== !!prevRootMenuState) {\n        if (!rootMenuState) {\n          onClose?.();\n        } else if (rootMenuState) {\n          onOpen?.();\n        }\n      }\n    });\n\n    // Controlled opening/closing of the menu\n    const openCloseMenu = useCallback(\n      (open: boolean) =>\n        dispatch({\n          type: open\n            ? CascadingMenuAction.OPEN_MENU\n            : CascadingMenuAction.CLOSE_CASCADING_MENU,\n          cause: stateChangeTypes.MOUSE_TOGGLE,\n          targetId: rootMenuId!,\n        }),\n      [rootMenuId]\n    );\n    // do not re-render every time if prop does not change\n    useEffect(() => {\n      if (openProp !== undefined && openProp !== !!rootMenuState) {\n        openCloseMenu(openProp);\n      }\n    });\n\n    const clickAwayNodes = disableClickAway\n      ? null\n      : () =>\n          [getMenuTriggerRef(), ...refsManager.values()].filter(\n            (node) => node !== null\n          ) as HTMLElement[];\n    useClickAway(\n      clickAwayNodes,\n      containingDocument,\n      () => {\n        dispatch({\n          type: CascadingMenuAction.CLOSE_CASCADING_MENU,\n          cause: stateChangeTypes.CLICKED_AWAY,\n          targetId: rootMenuId!,\n        });\n      },\n      () => {\n        setIsNavigatingWithKeyboard(false);\n      }\n    );\n\n    const handleResize = useEventCallback(() => {\n      if (rootMenuState) {\n        dispatch({\n          type: CascadingMenuAction.CLOSE_CASCADING_MENU,\n          cause: stateChangeTypes.ON_RESIZE,\n          targetId: rootMenuId!,\n        });\n      }\n    });\n\n    useEffect(() => {\n      const win = ownerWindow(getMenuTriggerRef());\n\n      win.addEventListener(\"resize\", handleResize);\n      return () => {\n        win.removeEventListener(\"resize\", handleResize);\n      };\n    }, [getMenuTriggerRef, handleResize]);\n\n    // close the menu on item click via mouse\n    const onItemClickCallback = useCallback(\n      (sourceItem: MenuDescriptor, event: KeyboardEvent | MouseEvent) => {\n        onItemClick?.(sourceItem, event);\n\n        if (!isNavigatingWithKeyboard) {\n          dispatch({\n            type: CascadingMenuAction.CLOSE_CASCADING_MENU,\n            cause: stateChangeTypes.ITEM_CLICKED,\n            targetId: rootMenuId!,\n          });\n        }\n      },\n      [isNavigatingWithKeyboard, onItemClick, rootMenuId]\n    );\n\n    // Set up event handlers on menu trigger if passed\n    const setMenuTriggerRef = useCallback((node: HTMLElement) => {\n      childrenRef.current = node;\n    }, []);\n    const handleRef = useForkRef(\n      //TODO get to bottom of this\n      // @ts-ignore\n      isValidElement(children) ? children.ref : noop,\n      setMenuTriggerRef\n    );\n\n    const [onMenuTriggerClick, onMenuTriggerKeydown] = useMenuTriggerHandlers({\n      dispatch,\n      children,\n      setIsNavigatingWithKeyboard,\n      openCloseMenu,\n      rootMenuState,\n      rootMenuId,\n      menusDataById,\n    });\n\n    const cloneMenuChildren = (cloneChildren: ReactNode) => {\n      if (isValidElement(cloneChildren)) {\n        const childrenProps = {\n          ...cloneChildren.props,\n        };\n\n        if (openProp === undefined) {\n          childrenProps.onClick = onMenuTriggerClick;\n          childrenProps.onKeyDown = onMenuTriggerKeydown;\n        }\n\n        return cloneElement(cloneChildren, {\n          ref: handleRef,\n          ...childrenProps,\n        });\n      }\n      return null;\n    };\n\n    const clonedChildren = cloneMenuChildren(children);\n\n    const commonMenuProps = {\n      className,\n      delay,\n      itemToString,\n      maxWidth,\n      minWidth,\n      onItemClick: onItemClickCallback,\n      dispatch,\n      isNavigatingWithKeyboard,\n      setIsNavigatingWithKeyboard,\n      menusDataById,\n      tooltipEnterDelay,\n      tooltipLeaveDelay,\n      rootPlacement,\n      rootPlacementOffset,\n      getScreenBounds,\n      disableMouseOutInteractions,\n    };\n\n    useEffect(() => {\n      if (!openProp) {\n        setIsNavigatingWithKeyboard(false);\n      }\n    }, [openProp, rootPlacementOffset]);\n\n    return Object.keys(menusDataById).length > 0 ? (\n      <>\n        {clonedChildren || null}\n        {Object.values(state).map((menuState) => {\n          const data = menusDataById[menuState.id];\n\n          const isRoot = data.level === 0;\n          const parentElement = isRoot\n            ? getMenuTriggerRef()\n            : refsManager.get(data.parentId!);\n\n          const isChildMenuOpen = !!state[data.level + 1];\n          return (\n            <CascadingMenuList\n              {...commonMenuProps}\n              data={data}\n              height={height}\n              highlightedItemIndex={menuState.highlightedItemIndex}\n              isChildMenuOpen={isChildMenuOpen}\n              isRoot={isRoot}\n              key={`${density}${menuState.id}`}\n              menuId={menuState.id}\n              menuTriggerRef={getMenuTriggerRef()}\n              parentElement={parentElement}\n              ref={isRoot ? ref : null}\n              refsManager={refsManager}\n              rowHeight={rowHeight}\n            />\n          );\n        })}\n      </>\n    ) : null;\n  }\n);\n"],"names":["forwardRef","CascadingMenu","defaultGetScreenBounds","useDensity","useRefsManager","useRef","useCallback","useControlled","useState","useMemo","deriveFlatStateFromTree","useStateReducer","useReducer","usePrevious","useEffect","CascadingMenuAction","stateChangeTypes","useClickAway","useEventCallback","ownerWindow","useForkRef","isValidElement","useMenuTriggerHandlers","cloneElement","jsxs","Fragment","createElement","CascadingMenuList"],"mappings":"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"}