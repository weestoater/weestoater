import { ownerDocument } from '@salt-ds/core';
import { useRef, useEffect } from 'react';

function getSelectionRange(input, { highlightOnFocus, cursorPositionOnFocus }) {
  if (highlightOnFocus === true) {
    return [0, input.value.length];
  }
  if (Array.isArray(highlightOnFocus) && highlightOnFocus.length > 1) {
    return [highlightOnFocus[0], highlightOnFocus[1]];
  }
  if (cursorPositionOnFocus === "start") {
    return [0, 0];
  }
  if (cursorPositionOnFocus === "end") {
    return [input.value.length, input.value.length];
  }
  if (cursorPositionOnFocus != null && !isNaN(cursorPositionOnFocus)) {
    return [cursorPositionOnFocus, cursorPositionOnFocus];
  }
  return [null, null];
}
function isSafari() {
  return navigator.userAgent.toLowerCase().includes("safari") && !navigator.userAgent.toLowerCase().includes("chrome");
}
function isFirefox() {
  return navigator.userAgent.toLowerCase().includes("firefox");
}
function useCursorOnFocus(inputRef, { cursorPositionOnFocus, highlightOnFocus }) {
  const wasClick = useRef(false);
  const timeoutRef = useRef(-1);
  const originalCursorPosition = useRef(-1);
  const selectionInProgress = useRef(false);
  const mouseMovement = useRef(0);
  const selection = useRef([null, null]);
  const wasWindowFocus = useRef(false);
  const handleMouseDown = () => {
    wasClick.current = true;
  };
  const handleMouseMove = (event) => {
    var _a;
    if (selectionInProgress.current) {
      mouseMovement.current += Math.abs(event.movementX) + Math.abs(event.movementY);
      if (mouseMovement.current < 3) {
        event.preventDefault();
        return;
      }
      if (typeof originalCursorPosition.current == "number") {
        (_a = inputRef.current) == null ? void 0 : _a.setSelectionRange(
          originalCursorPosition.current,
          originalCursorPosition.current
        );
      }
      selectionInProgress.current = false;
    }
  };
  const handleMouseUp = () => {
    const isValidBrowser = isFirefox() || isSafari();
    if (selectionInProgress.current && mouseMovement.current < 3 && isValidBrowser && Array.isArray(selection.current)) {
      const [start, end] = selection.current;
      setTimeout(() => {
        var _a, _b, _c;
        if ((((_a = inputRef.current) == null ? void 0 : _a.selectionStart) !== start || ((_b = inputRef.current) == null ? void 0 : _b.selectionEnd) !== end) && typeof start === "number" && typeof end === "number") {
          (_c = inputRef.current) == null ? void 0 : _c.setSelectionRange(start, end);
        }
      }, 0);
    }
    wasClick.current = false;
    selectionInProgress.current = false;
    mouseMovement.current = 0;
  };
  useEffect(() => {
    if (cursorPositionOnFocus != null || highlightOnFocus != null) {
      const handleFocusBehaviour = () => {
        var _a;
        if (!inputRef.current) {
          return;
        }
        const [start, end] = getSelectionRange(inputRef.current, {
          highlightOnFocus,
          cursorPositionOnFocus
        });
        if (start !== null && end !== null) {
          window.clearTimeout(timeoutRef.current);
          const needsTimeout = isSafari() || wasClick.current;
          if (wasClick.current) {
            selectionInProgress.current = true;
            mouseMovement.current = 0;
          }
          selection.current = [start, end];
          if (needsTimeout) {
            timeoutRef.current = window.setTimeout(() => {
              var _a2, _b;
              if (wasClick.current) {
                originalCursorPosition.current = (_a2 = inputRef.current) == null ? void 0 : _a2.selectionStart;
              }
              (_b = inputRef.current) == null ? void 0 : _b.setSelectionRange(start, end);
            }, 0);
          } else {
            (_a = inputRef.current) == null ? void 0 : _a.setSelectionRange(start, end);
          }
        }
      };
      const handleFocusIn = () => {
        if (wasWindowFocus.current) {
          wasWindowFocus.current = false;
          return;
        }
        if (cursorPositionOnFocus != null || highlightOnFocus != null) {
          handleFocusBehaviour();
        }
      };
      const handleWindowFocus = () => {
        const doc2 = ownerDocument(inputRef.current);
        if (doc2.visibilityState === "visible" && doc2.activeElement === inputRef.current) {
          wasClick.current = false;
          selectionInProgress.current = false;
          mouseMovement.current = 0;
          wasWindowFocus.current = true;
        }
      };
      const eventName = isSafari() || isFirefox() ? "focusIn" : "focus";
      const input = inputRef.current;
      const doc = ownerDocument(inputRef.current);
      input == null ? void 0 : input.addEventListener(eventName, handleFocusIn);
      doc.addEventListener("visibilitychange", handleWindowFocus);
      return () => {
        input == null ? void 0 : input.removeEventListener(eventName, handleFocusIn);
        doc == null ? void 0 : doc.removeEventListener("visibilitychange", handleWindowFocus);
      };
    }
    return void 0;
  }, [cursorPositionOnFocus, highlightOnFocus, inputRef]);
  return { handleMouseDown, handleMouseMove, handleMouseUp };
}

export { useCursorOnFocus };
//# sourceMappingURL=useCursorOnFocus.js.map
