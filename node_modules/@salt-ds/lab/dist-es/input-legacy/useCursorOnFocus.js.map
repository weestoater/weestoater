{"version":3,"file":"useCursorOnFocus.js","sources":["../src/input-legacy/useCursorOnFocus.ts"],"sourcesContent":["import { ownerDocument } from \"@salt-ds/core\";\nimport { MouseEvent, MutableRefObject, useEffect, useRef } from \"react\";\n\nfunction getSelectionRange(\n  input: HTMLInputElement,\n  { highlightOnFocus, cursorPositionOnFocus }: useCursorOnFocusProps\n): [number | null, number | null] {\n  // highlightOnFocus highlight first so it takes priority over position on focus\n  if (highlightOnFocus === true) {\n    return [0, input.value.length];\n  }\n  if (Array.isArray(highlightOnFocus) && highlightOnFocus.length > 1) {\n    return [highlightOnFocus[0], highlightOnFocus[1]];\n  }\n\n  if (cursorPositionOnFocus === \"start\") {\n    return [0, 0];\n  }\n\n  if (cursorPositionOnFocus === \"end\") {\n    return [input.value.length, input.value.length];\n  }\n\n  if (cursorPositionOnFocus != null && !isNaN(cursorPositionOnFocus)) {\n    return [cursorPositionOnFocus, cursorPositionOnFocus];\n  }\n  return [null, null];\n}\n\nfunction isSafari() {\n  return (\n    navigator.userAgent.toLowerCase().includes(\"safari\") &&\n    !navigator.userAgent.toLowerCase().includes(\"chrome\")\n  );\n}\n\nfunction isFirefox() {\n  return navigator.userAgent.toLowerCase().includes(\"firefox\");\n}\n\nexport interface useCursorOnFocusProps {\n  /**\n   * Determines the position of the text cursor on focus of the input.\n   *\n   * start = place cursor at the beginning\n   * end = place cursor at the end\n   * \\# = index to place the cursor\n   */\n  cursorPositionOnFocus?: \"start\" | \"end\" | number;\n  /**\n   * Determines what gets highlighted on focus of the input.\n   *\n   * If `true` all text will be highlighted.\n   * If an array text between those indices will be highlighted\n   * e.g. [0,1] will highlight the first character.\n   */\n  highlightOnFocus?: boolean | number[];\n}\n\nexport function useCursorOnFocus(\n  inputRef: MutableRefObject<HTMLInputElement | null>,\n  { cursorPositionOnFocus, highlightOnFocus }: useCursorOnFocusProps\n) {\n  const wasClick = useRef(false);\n  const timeoutRef = useRef<number>(-1);\n  const originalCursorPosition = useRef<number | null | undefined>(-1);\n  const selectionInProgress = useRef(false);\n  const mouseMovement = useRef(0);\n\n  const selection = useRef<[number | null, number | null]>([null, null]);\n  const wasWindowFocus = useRef(false);\n\n  const handleMouseDown = () => {\n    wasClick.current = true;\n  };\n\n  const handleMouseMove = (event: MouseEvent) => {\n    if (selectionInProgress.current) {\n      mouseMovement.current +=\n        Math.abs(event.movementX) + Math.abs(event.movementY);\n\n      //Prevents the slightest mouse movement triggering the cursor to be repositioned.\n      if (mouseMovement.current < 3) {\n        event.preventDefault();\n\n        return;\n      }\n\n      if (typeof originalCursorPosition.current == \"number\") {\n        // Allows continued highlighted if the mouse down is part of a selection.\n        inputRef.current?.setSelectionRange(\n          originalCursorPosition.current,\n          originalCursorPosition.current\n        );\n      }\n\n      //Reset so originalCursorPosition is only set once.\n      selectionInProgress.current = false;\n    }\n  };\n\n  const handleMouseUp = () => {\n    const isValidBrowser = isFirefox() || isSafari();\n    if (\n      selectionInProgress.current &&\n      mouseMovement.current < 3 &&\n      isValidBrowser &&\n      Array.isArray(selection.current)\n    ) {\n      const [start, end] = selection.current;\n      setTimeout(() => {\n        if (\n          (inputRef.current?.selectionStart !== start ||\n            inputRef.current?.selectionEnd !== end) &&\n          typeof start === \"number\" &&\n          typeof end === \"number\"\n        ) {\n          inputRef.current?.setSelectionRange(start, end);\n        }\n      }, 0);\n    }\n\n    wasClick.current = false;\n    selectionInProgress.current = false;\n    mouseMovement.current = 0;\n  };\n\n  useEffect(() => {\n    if (cursorPositionOnFocus != null || highlightOnFocus != null) {\n      const handleFocusBehaviour = () => {\n        if (!inputRef.current) {\n          return;\n        }\n\n        const [start, end] = getSelectionRange(inputRef.current, {\n          highlightOnFocus,\n          cursorPositionOnFocus,\n        });\n        if (start !== null && end !== null) {\n          window.clearTimeout(timeoutRef.current);\n          const needsTimeout = isSafari() || wasClick.current;\n\n          if (wasClick.current) {\n            selectionInProgress.current = true;\n            mouseMovement.current = 0;\n          }\n\n          selection.current = [start, end];\n          // Keyboard focus needs to be outside setTimeout otherwise a flash of selected text appears.\n          if (needsTimeout) {\n            // Make's sure setSelectionRange is run after browser has set cursor position.\n            timeoutRef.current = window.setTimeout(() => {\n              if (wasClick.current) {\n                originalCursorPosition.current =\n                  inputRef.current?.selectionStart;\n              }\n              inputRef.current?.setSelectionRange(start, end);\n            }, 0);\n          } else {\n            inputRef.current?.setSelectionRange(start, end);\n          }\n        }\n      };\n\n      const handleFocusIn = () => {\n        // Ignore focus of input on window focus\n        if (wasWindowFocus.current) {\n          wasWindowFocus.current = false;\n          return;\n        }\n\n        if (cursorPositionOnFocus != null || highlightOnFocus != null) {\n          handleFocusBehaviour();\n        }\n      };\n\n      //Reset everything on window re-focus\n      const handleWindowFocus = () => {\n        const doc = ownerDocument(inputRef.current);\n        if (\n          doc.visibilityState === \"visible\" &&\n          doc.activeElement === inputRef.current\n        ) {\n          wasClick.current = false;\n          selectionInProgress.current = false;\n          mouseMovement.current = 0;\n          wasWindowFocus.current = true;\n        }\n      };\n\n      const eventName = isSafari() || isFirefox() ? \"focusIn\" : \"focus\";\n      const input = inputRef.current;\n      const doc = ownerDocument(inputRef.current);\n      input?.addEventListener(eventName, handleFocusIn);\n      doc.addEventListener(\"visibilitychange\", handleWindowFocus);\n\n      return () => {\n        input?.removeEventListener(eventName, handleFocusIn);\n        doc?.removeEventListener(\"visibilitychange\", handleWindowFocus);\n      };\n    }\n\n    return undefined;\n  }, [cursorPositionOnFocus, highlightOnFocus, inputRef]);\n\n  return { handleMouseDown, handleMouseMove, handleMouseUp };\n}\n"],"names":["_a","doc"],"mappings":"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"}